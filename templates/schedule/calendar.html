{% extends 'base.html' %}
{% load schedule_tags %}

{% block title %}ì¼ì • - í…Œë‹ˆìŠ¤ í´ëŸ½{% endblock %}

{% block page_title %}í´ëŸ½ ì¼ì •{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="openModal('addEventModal')">
    <span>â•</span> ì¼ì • ì¶”ê°€
</button>
{% endblock %}

{% block content %}
<!-- ìº˜ë¦°ë” ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="calendar-nav">
    <button class="btn btn-secondary" onclick="location.href='?year={{ prev_year }}&month={{ prev_month }}'">
        â—€ ì´ì „
    </button>
    <h2 class="calendar-title">{{ month_name }}</h2>
    <button class="btn btn-secondary" onclick="location.href='?year={{ next_year }}&month={{ next_month }}'">
        ë‹¤ìŒ â–¶
    </button>
</div>

<!-- ìº˜ë¦°ë” ê·¸ë¦¬ë“œ -->
<div class="calendar-grid">
    <!-- ìš”ì¼ í—¤ë” -->
    <div class="calendar-header-cell sunday">ì¼</div>
    <div class="calendar-header-cell">ì›”</div>
    <div class="calendar-header-cell">í™”</div>
    <div class="calendar-header-cell">ìˆ˜</div>
    <div class="calendar-header-cell">ëª©</div>
    <div class="calendar-header-cell">ê¸ˆ</div>
    <div class="calendar-header-cell saturday">í† </div>
    
    <!-- ë‚ ì§œ ì…€ -->
    {% for week in month_days %}
        {% for day in week %}
            {% with day_str=day|date:"Y-m-d" %}
            <div class="calendar-cell {% if day.month != month %}other-month{% endif %} {% if day == today %}today{% endif %}"
                 onclick="openAddEventModal('{{ day_str }}')">
                <div class="calendar-day">{{ day.day }}</div>
                {% if day_str in events_by_date %}
                    {% for event in events_by_date|get_item:day_str %}
                    <div class="calendar-event {% if event.is_recurring %}recurring-event{% endif %}" 
                         onclick="event.stopPropagation(); viewEvent({{ event.id }})">
                        {% if event.is_recurring %}ğŸ”„{% endif %}{{ event.title }}
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            {% endwith %}
        {% endfor %}
    {% endfor %}
</div>

<!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addEventModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">ğŸ“… ìƒˆ ì¼ì • ì¶”ê°€</h3>
            <button class="modal-close" onclick="closeModal('addEventModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="addEventForm">
                <div class="form-group">
                    <label class="form-label">ì œëª© *</label>
                    <input type="text" name="title" class="form-control" required placeholder="ì¼ì • ì œëª©">
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚ ì§œ *</label>
                    <input type="date" name="date" id="eventDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹œì‘ ì‹œê°„ *</label>
                    <input type="time" name="start_time" class="form-control" required value="09:00">
                </div>
                <div class="form-group">
                    <label class="form-label">ì¢…ë£Œ ì‹œê°„ *</label>
                    <input type="time" name="end_time" class="form-control" required value="12:00">
                </div>
                <div class="form-group">
                    <label class="form-label">ì¥ì†Œ *</label>
                    <input type="text" name="location" class="form-control" required placeholder="í…Œë‹ˆìŠ¤ì¥ ìœ„ì¹˜">
                </div>
                <div class="form-group">
                    <label class="form-label">ì„¤ëª…</label>
                    <textarea name="description" class="form-control" rows="3" placeholder="ì¶”ê°€ ì •ë³´"></textarea>
                </div>
                
                <!-- ë°˜ë³µ ì„¤ì • ì„¹ì…˜ -->
                <div class="form-group">
                    <label class="form-label">ğŸ”„ ë°˜ë³µ ì„¤ì •</label>
                    <select name="recurrence_type" id="recurrenceType" class="form-control" onchange="toggleRecurrenceOptions()">
                        <option value="none">ë°˜ë³µ ì—†ìŒ</option>
                        <option value="daily">ë§¤ì¼</option>
                        <option value="weekly">ë§¤ì£¼</option>
                        <option value="custom">ì‚¬ìš©ì ì •ì˜</option>
                    </select>
                </div>
                
                <!-- ë°˜ë³µ ì˜µì…˜ (ë°˜ë³µ ì„ íƒ ì‹œ í‘œì‹œ) -->
                <div id="recurrenceOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">ë°˜ë³µ ì¢…ë£Œì¼ *</label>
                        <input type="date" name="recurrence_end_date" id="recurrenceEndDate" class="form-control">
                    </div>
                    
                    <!-- ì‚¬ìš©ì ì •ì˜ ìš”ì¼ ì„ íƒ -->
                    <div id="customWeekdaysSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">ë°˜ë³µ ìš”ì¼ ì„ íƒ</label>
                            <div class="weekday-selector">
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="0">
                                    <span>ì›”</span>
                                </label>
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="1">
                                    <span>í™”</span>
                                </label>
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="2">
                                    <span>ìˆ˜</span>
                                </label>
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="3">
                                    <span>ëª©</span>
                                </label>
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="4">
                                    <span>ê¸ˆ</span>
                                </label>
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="5">
                                    <span>í† </span>
                                </label>
                                <label class="weekday-btn">
                                    <input type="checkbox" name="weekdays" value="6">
                                    <span>ì¼</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ì°¸ì„ ë©¤ë²„</label>
                    <div class="participant-grid" style="max-height: 200px; overflow-y: auto;">
                        {% for member in members %}
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="attendees" value="{{ member.id }}">
                            <span>{{ member.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addEventModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitAddEvent()">ì¶”ê°€í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ì¼ì • ìƒì„¸ ëª¨ë‹¬ -->
<div id="viewEventModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="viewEventTitle">ğŸ“… ì¼ì • ìƒì„¸</h3>
            <button class="modal-close" onclick="closeModal('viewEventModal')">Ã—</button>
        </div>
        <div class="modal-body" id="viewEventContent">
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="deleteEventBtn" onclick="showDeleteOptions()">ì‚­ì œ</button>
            <button class="btn btn-primary" onclick="openEditEventModal()">ìˆ˜ì •</button>
            <button class="btn btn-success" onclick="goToMatchmaking()">ğŸ¾ ëŒ€ì§„í‘œ ìƒì„±</button>
            <button class="btn btn-secondary" onclick="closeModal('viewEventModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ì¼ì • ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editEventModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">âœï¸ ì¼ì • ìˆ˜ì •</h3>
            <button class="modal-close" onclick="closeModal('editEventModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="editEventForm">
                <div class="form-group">
                    <label class="form-label">ì œëª© *</label>
                    <input type="text" name="title" id="editEventTitle" class="form-control" required placeholder="ì¼ì • ì œëª©">
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚ ì§œ *</label>
                    <input type="date" name="date" id="editEventDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ì‹œì‘ ì‹œê°„ *</label>
                    <input type="time" name="start_time" id="editEventStartTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ì¢…ë£Œ ì‹œê°„ *</label>
                    <input type="time" name="end_time" id="editEventEndTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ì¥ì†Œ *</label>
                    <input type="text" name="location" id="editEventLocation" class="form-control" required placeholder="í…Œë‹ˆìŠ¤ì¥ ìœ„ì¹˜">
                </div>
                <div class="form-group">
                    <label class="form-label">ì„¤ëª…</label>
                    <textarea name="description" id="editEventDescription" class="form-control" rows="3" placeholder="ì¶”ê°€ ì •ë³´"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ì°¸ì„ ë©¤ë²„</label>
                    <div class="participant-grid" id="editAttendeesGrid" style="max-height: 200px; overflow-y: auto;">
                        {% for member in members %}
                        <label class="checkbox-wrapper">
                            <input type="checkbox" name="edit_attendees" value="{{ member.id }}">
                            <span>{{ member.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editEventModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitEditEvent()">ì €ì¥</button>
        </div>
    </div>
</div>

<!-- ì‚­ì œ ì˜µì…˜ ëª¨ë‹¬ (ë°˜ë³µ ì¼ì •ìš©) -->
<div id="deleteOptionsModal" class="modal-overlay">
    <div class="modal" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">ğŸ—‘ï¸ ì¼ì • ì‚­ì œ</h3>
            <button class="modal-close" onclick="closeModal('deleteOptionsModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 16px;">ë°˜ë³µ ì¼ì •ì…ë‹ˆë‹¤. ì–´ë–»ê²Œ ì‚­ì œí• ê¹Œìš”?</p>
            <div class="delete-options">
                <button class="btn btn-outline" onclick="deleteEvent('single')" style="width: 100%; margin-bottom: 8px;">
                    ğŸ“Œ ì´ë²ˆ ì¼ì •ë§Œ ì‚­ì œ
                </button>
                <button class="btn btn-outline" onclick="deleteEvent('future')" style="width: 100%; margin-bottom: 8px;">
                    â© ì´ë²ˆ ë° ì•ìœ¼ë¡œì˜ ì¼ì • ì‚­ì œ
                </button>
                <button class="btn btn-danger" onclick="deleteEvent('all')" style="width: 100%;">
                    ğŸ—‘ï¸ ëª¨ë“  ë°˜ë³µ ì¼ì • ì‚­ì œ
                </button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('deleteOptionsModal')">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEventId = null;
let currentEventIsRecurring = false;
let currentEventData = null;  // í˜„ì¬ ë³´ê³  ìˆëŠ” ì´ë²¤íŠ¸ ë°ì´í„° ì €ì¥

// URL íŒŒë¼ë¯¸í„°ì—ì„œ event ID í™•ì¸í•˜ì—¬ ìë™ìœ¼ë¡œ ëª¨ë‹¬ ì—´ê¸°
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('event');
    
    if (eventId) {
        // URLì—ì„œ event íŒŒë¼ë¯¸í„° ì œê±° (íˆìŠ¤í† ë¦¬ ì •ë¦¬)
        const cleanUrl = window.location.pathname + 
            (urlParams.toString() ? '?' + urlParams.toString().replace(/event=[^&]*&?/, '').replace(/&$/, '') : '');
        window.history.replaceState({}, '', cleanUrl || window.location.pathname);
        
        // ì¼ì • ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        viewEvent(parseInt(eventId));
    }
});

function openAddEventModal(dateStr) {
    document.getElementById('eventDate').value = dateStr || '';
    // ê¸°ë³¸ê°’ìœ¼ë¡œ 3ê°œì›” í›„ ì„¤ì •
    if (dateStr) {
        const endDate = new Date(dateStr);
        endDate.setMonth(endDate.getMonth() + 3);
        document.getElementById('recurrenceEndDate').value = endDate.toISOString().split('T')[0];
    }
    openModal('addEventModal');
}

function toggleRecurrenceOptions() {
    const recurrenceType = document.getElementById('recurrenceType').value;
    const optionsDiv = document.getElementById('recurrenceOptions');
    const customSection = document.getElementById('customWeekdaysSection');
    
    if (recurrenceType === 'none') {
        optionsDiv.style.display = 'none';
    } else {
        optionsDiv.style.display = 'block';
        
        if (recurrenceType === 'custom') {
            customSection.style.display = 'block';
        } else {
            customSection.style.display = 'none';
        }
    }
}

async function submitAddEvent() {
    const form = document.getElementById('addEventForm');
    const formData = new FormData(form);
    
    // ì°¸ì„ì ë°°ì—´ë¡œ ë³€í™˜
    const attendees = [];
    form.querySelectorAll('input[name="attendees"]:checked').forEach(cb => {
        attendees.push(parseInt(cb.value));
    });
    
    // ì„ íƒëœ ìš”ì¼ ë°°ì—´ë¡œ ë³€í™˜
    const weekdays = [];
    form.querySelectorAll('input[name="weekdays"]:checked').forEach(cb => {
        weekdays.push(parseInt(cb.value));
    });
    
    const recurrenceType = formData.get('recurrence_type');
    
    // ë°˜ë³µ ì„¤ì • ê²€ì¦
    if (recurrenceType !== 'none') {
        const endDate = formData.get('recurrence_end_date');
        if (!endDate) {
            showToast('ë°˜ë³µ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            return;
        }
        
        if (recurrenceType === 'custom' && weekdays.length === 0) {
            showToast('ë°˜ë³µí•  ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
            return;
        }
    }
    
    const data = {
        title: formData.get('title'),
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location'),
        description: formData.get('description'),
        attendees: attendees,
        recurrence_type: recurrenceType,
        recurrence_end_date: formData.get('recurrence_end_date'),
        recurrence_weekdays: weekdays,
    };
    
    try {
        const result = await fetchWithCSRF('/schedule/api/event/create/', {
            method: 'POST',
            body: JSON.stringify(data),
        });
        
        if (result.success) {
            let message = 'ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰';
            if (result.created_count > 1) {
                message = `${result.created_count}ê°œì˜ ì¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`;
            }
            showToast(message);
            closeModal('addEventModal');
            location.reload();
        } else {
            showToast(result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

async function viewEvent(eventId) {
    currentEventId = eventId;
    
    try {
        const response = await fetch(`/schedule/api/event/${eventId}/`);
        const event = await response.json();
        
        currentEventData = event;
        currentEventIsRecurring = event.is_recurring;
        
        document.getElementById('viewEventTitle').textContent = `ğŸ“… ${event.title}`;
        
        // ì°¸ì„ìë¥¼ ì„±ë³„ë¡œ ë¶„ë¦¬
        let attendeesHtml = '';
        if (event.attendees.length > 0) {
            const males = event.attendees.filter(a => a.gender === 'M');
            const females = event.attendees.filter(a => a.gender === 'F');
            
            attendeesHtml = `
                <div class="attendees-grid">
                    <div class="attendees-group males">
                        <div class="group-header">ğŸ™‹â€â™‚ï¸ ë‚¨ì <span class="count">${males.length}ëª…</span></div>
                        <div class="group-members">
                            ${males.length > 0 ? males.map(a => `<span class="attendee-badge male">${a.name}</span>`).join('') : '<span class="no-attendee">-</span>'}
                        </div>
                    </div>
                    <div class="attendees-group females">
                        <div class="group-header">ğŸ™‹â€â™€ï¸ ì—¬ì <span class="count">${females.length}ëª…</span></div>
                        <div class="group-members">
                            ${females.length > 0 ? females.map(a => `<span class="attendee-badge female">${a.name}</span>`).join('') : '<span class="no-attendee">-</span>'}
                        </div>
                    </div>
                </div>
            `;
        } else {
            attendeesHtml = '<div class="no-attendees">ì°¸ì„ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        document.getElementById('viewEventContent').innerHTML = `
            <div class="event-detail-card">
                <!-- ìƒë‹¨: ë‚ ì§œ + ê¸°ë³¸ ì •ë³´ -->
                <div class="event-hero">
                    <div class="event-date-badge">
                        <span class="date-month">${new Date(event.date).toLocaleDateString('ko-KR', { month: 'short' })}</span>
                        <span class="date-day">${new Date(event.date).getDate()}</span>
                        <span class="date-weekday">${new Date(event.date).toLocaleDateString('ko-KR', { weekday: 'short' })}</span>
                    </div>
                    <div class="event-main-info">
                        <div class="event-info-row">
                            <span class="info-icon">ğŸ•</span>
                            <span class="info-text">${event.start_time} - ${event.end_time}</span>
                        </div>
                        <div class="event-info-row">
                            <span class="info-icon">ğŸ“</span>
                            <span class="info-text">${event.location}</span>
                        </div>
                        ${event.is_recurring ? `
                        <div class="event-info-row recurrence">
                            <span class="info-icon">ğŸ”„</span>
                            <span class="info-text">${
                                event.recurrence_type === 'daily' ? 'ë§¤ì¼ ë°˜ë³µ' :
                                event.recurrence_type === 'weekly' ? 'ë§¤ì£¼ ë°˜ë³µ' :
                                event.recurrence_type === 'custom' ? `ë§¤ì£¼ ${event.recurrence_weekdays.map(d => ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'][d]).join(', ')}` :
                                'ë°˜ë³µ ì¼ì •'
                            }</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${event.description ? `
                <!-- ë©”ëª¨ ì„¹ì…˜ -->
                <div class="event-section description">
                    <div class="event-section-header">
                        <span class="event-section-title">ğŸ“ ë©”ëª¨</span>
                    </div>
                    <div class="event-section-content">${event.description}</div>
                </div>
                ` : ''}
                
                <!-- ì°¸ì„ì ì„¹ì…˜ -->
                <div class="event-section attendees">
                    <div class="event-section-header">
                        <span class="event-section-title">ğŸ‘¥ ì°¸ì„ì</span>
                        <span class="event-section-badge">${event.attendees.length}ëª…</span>
                    </div>
                    <div class="event-section-content">
                        ${attendeesHtml}
                    </div>
                </div>
            </div>
        `;
        
        openModal('viewEventModal');
    } catch (error) {
        showToast('ì¼ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    }
}

function goToMatchmaking() {
    if (!currentEventData) {
        showToast('ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    // ì°¸ì„ì ID ë°°ì—´ ë§Œë“¤ê¸°
    const attendeeIds = currentEventData.attendees.map(a => a.id);
    
    // URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
    const params = new URLSearchParams();
    if (attendeeIds.length > 0) {
        params.set('members', attendeeIds.join(','));
    }
    params.set('date', currentEventData.date);
    params.set('title', currentEventData.title);
    
    // ëŒ€ì§„í‘œ í˜ì´ì§€ë¡œ ì´ë™
    window.location.href = `/matchmaking/?${params.toString()}`;
}

function showDeleteOptions() {
    if (!currentEventId) return;
    
    if (currentEventIsRecurring) {
        // ë°˜ë³µ ì¼ì •ì¸ ê²½ìš° ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
        closeModal('viewEventModal');
        openModal('deleteOptionsModal');
    } else {
        // ë‹¨ì¼ ì¼ì •ì¸ ê²½ìš° ë°”ë¡œ ì‚­ì œ
        if (confirm('ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            deleteEvent('single');
        }
    }
}

async function deleteEvent(deleteType) {
    if (!currentEventId) return;
    
    try {
        const result = await fetchWithCSRF(`/schedule/api/event/delete/${currentEventId}/`, {
            method: 'POST',
            body: JSON.stringify({ delete_type: deleteType }),
        });
        
        if (result.success) {
            let message = 'ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤';
            if (result.deleted_count > 1) {
                message = `${result.deleted_count}ê°œì˜ ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`;
            }
            showToast(message);
            closeModal('viewEventModal');
            closeModal('deleteOptionsModal');
            location.reload();
        } else {
            showToast(result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// ì¼ì • ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function openEditEventModal() {
    if (!currentEventData) {
        showToast('ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    const event = currentEventData;
    
    // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
    document.getElementById('editEventTitle').value = event.title;
    document.getElementById('editEventDate').value = event.date;
    document.getElementById('editEventStartTime').value = event.start_time;
    document.getElementById('editEventEndTime').value = event.end_time;
    document.getElementById('editEventLocation').value = event.location;
    document.getElementById('editEventDescription').value = event.description || '';
    
    // ì°¸ì„ì ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
    const attendeeIds = event.attendees.map(a => a.id);
    document.querySelectorAll('#editAttendeesGrid input[name="edit_attendees"]').forEach(cb => {
        cb.checked = attendeeIds.includes(parseInt(cb.value));
    });
    
    closeModal('viewEventModal');
    openModal('editEventModal');
}

// ì¼ì • ìˆ˜ì • ì œì¶œ
async function submitEditEvent() {
    if (!currentEventId) return;
    
    const form = document.getElementById('editEventForm');
    const title = document.getElementById('editEventTitle').value.trim();
    
    if (!title) {
        showToast('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    // ì°¸ì„ì ë°°ì—´ë¡œ ë³€í™˜
    const attendees = [];
    form.querySelectorAll('input[name="edit_attendees"]:checked').forEach(cb => {
        attendees.push(parseInt(cb.value));
    });
    
    const data = {
        title: title,
        date: document.getElementById('editEventDate').value,
        start_time: document.getElementById('editEventStartTime').value,
        end_time: document.getElementById('editEventEndTime').value,
        location: document.getElementById('editEventLocation').value,
        description: document.getElementById('editEventDescription').value,
        attendees: attendees,
    };
    
    try {
        const result = await fetchWithCSRF(`/schedule/api/event/update/${currentEventId}/`, {
            method: 'POST',
            body: JSON.stringify(data),
        });
        
        if (result.success) {
            showToast('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
            closeModal('editEventModal');
            location.reload();
        } else {
            showToast(result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}
</script>

<style>
/* ë°˜ë³µ ì¼ì • ìŠ¤íƒ€ì¼ */
.recurring-event {
    border-left: 3px solid #4CAF50 !important;
}

/* ìš”ì¼ ì„ íƒê¸° ìŠ¤íƒ€ì¼ */
.weekday-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.weekday-btn {
    display: inline-block;
}

.weekday-btn input[type="checkbox"] {
    display: none;
}

.weekday-btn span {
    display: inline-block;
    width: 40px;
    height: 40px;
    line-height: 40px;
    text-align: center;
    border: 2px solid #ddd;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
}

.weekday-btn input:checked + span {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.weekday-btn span:hover {
    border-color: var(--primary-color);
}

/* ì‚­ì œ ì˜µì…˜ ë²„íŠ¼ */
.btn-outline {
    background: transparent;
    border: 2px solid #ddd;
    color: #333;
}

.btn-outline:hover {
    background: #f5f5f5;
    border-color: #bbb;
}
</style>
{% endblock %}
