{% extends 'base.html' %}

{% block title %}ë©¤ë²„ ê´€ë¦¬ - í…Œë‹ˆìŠ¤ í´ëŸ½{% endblock %}

{% block page_title %}ë©¤ë²„ ê´€ë¦¬{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="openModal('addMemberModal')">
    <span>â•</span> ë©¤ë²„ ì¶”ê°€
</button>
{% endblock %}

{% block content %}
<div class="tabs">
    <button class="tab active" data-tab="active-members">í™œë™ì¤‘ ({{ active_members|length }})</button>
    <button class="tab" data-tab="inactive-members">íœ´íšŒì¤‘ ({{ inactive_members|length }})</button>
</div>

<!-- í™œë™ì¤‘ ë©¤ë²„ -->
<div id="active-members" class="tab-content">
    {% if active_members %}
    <div class="member-grid">
        {% for member in active_members %}
        <div class="member-card" data-member-id="{{ member.id }}" onclick="viewMemberDetail({{ member.id }})" style="cursor: pointer;">
            <div class="member-card-header">
                <div class="member-avatar-wrapper">
                    <div class="member-avatar {% if member.gender == 'M' %}male{% else %}female{% endif %}">
                        {% if member.gender == 'M' %}ğŸ™‹â€â™‚ï¸{% else %}ğŸ™‹â€â™€ï¸{% endif %}
                    </div>
                    {% if member.is_admin %}<span class="admin-badge">ğŸ‘‘</span>{% endif %}
                </div>
                <div>
                    <div class="member-name">{{ member.name }}</div>
                    <div class="member-status">
                        <span class="badge badge-success">í™œë™ì¤‘</span>
                    </div>
                </div>
            </div>
            <div class="member-details">
                <div class="member-detail-item">
                    <div class="member-detail-label">ì„±ë³„</div>
                    <div class="member-detail-value">{{ member.get_gender_display }}</div>
                </div>
                <div class="member-detail-item">
                    <div class="member-detail-label">êµ¬ë ¥</div>
                    <div class="member-detail-value">{{ member.experience_years }}ë…„</div>
                </div>
                <div class="member-detail-item">
                    <div class="member-detail-label">NTRP</div>
                    <div class="member-detail-value">{{ member.ntrp }}</div>
                </div>
                <div class="member-detail-item">
                    <div class="member-detail-label">ì—°ë½ì²˜</div>
                    <div class="member-detail-value">{{ member.phone|default:'-' }}</div>
                </div>
            </div>
            <div class="member-card-actions">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editMember({{ member.id }}, '{{ member.name }}', '{{ member.gender }}', {{ member.experience_years }}, '{{ member.ntrp }}', '{{ member.status }}', '{{ member.phone }}', {{ member.is_admin|yesno:'true,false' }})">
                    âœï¸ ìˆ˜ì •
                </button>
                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteMember({{ member.id }}, '{{ member.name }}')">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ‘¥</div>
        <div class="empty-state-text">í™œë™ì¤‘ì¸ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-state-subtext">ë©¤ë²„ ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆ ë©¤ë²„ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
    </div>
    {% endif %}
</div>

<!-- íœ´íšŒì¤‘ ë©¤ë²„ -->
<div id="inactive-members" class="tab-content" style="display: none;">
    {% if inactive_members %}
    <div class="member-grid">
        {% for member in inactive_members %}
        <div class="member-card" data-member-id="{{ member.id }}" onclick="viewMemberDetail({{ member.id }})" style="cursor: pointer;">
            <div class="member-card-header">
                <div class="member-avatar-wrapper">
                    <div class="member-avatar {% if member.gender == 'M' %}male{% else %}female{% endif %}" style="opacity: 0.6;">
                        {% if member.gender == 'M' %}ğŸ™‹â€â™‚ï¸{% else %}ğŸ™‹â€â™€ï¸{% endif %}
                    </div>
                    {% if member.is_admin %}<span class="admin-badge">ğŸ‘‘</span>{% endif %}
                </div>
                <div>
                    <div class="member-name">{{ member.name }}</div>
                    <div class="member-status">
                        <span class="badge badge-warning">íœ´íšŒì¤‘</span>
                    </div>
                </div>
            </div>
            <div class="member-details">
                <div class="member-detail-item">
                    <div class="member-detail-label">ì„±ë³„</div>
                    <div class="member-detail-value">{{ member.get_gender_display }}</div>
                </div>
                <div class="member-detail-item">
                    <div class="member-detail-label">êµ¬ë ¥</div>
                    <div class="member-detail-value">{{ member.experience_years }}ë…„</div>
                </div>
                <div class="member-detail-item">
                    <div class="member-detail-label">NTRP</div>
                    <div class="member-detail-value">{{ member.ntrp }}</div>
                </div>
                <div class="member-detail-item">
                    <div class="member-detail-label">ì—°ë½ì²˜</div>
                    <div class="member-detail-value">{{ member.phone|default:'-' }}</div>
                </div>
            </div>
            <div class="member-card-actions">
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editMember({{ member.id }}, '{{ member.name }}', '{{ member.gender }}', {{ member.experience_years }}, '{{ member.ntrp }}', '{{ member.status }}', '{{ member.phone }}', {{ member.is_admin|yesno:'true,false' }})">
                    âœï¸ ìˆ˜ì •
                </button>
                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteMember({{ member.id }}, '{{ member.name }}')">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ˜´</div>
        <div class="empty-state-text">íœ´íšŒì¤‘ì¸ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
    </div>
    {% endif %}
</div>

<!-- ë©¤ë²„ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="addMemberModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">ğŸ¾ ìƒˆ ë©¤ë²„ ì¶”ê°€</h3>
            <button class="modal-close" onclick="closeModal('addMemberModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="addMemberForm">
                <div class="form-group">
                    <label class="form-label">ì´ë¦„ *</label>
                    <input type="text" name="name" class="form-control" required placeholder="ë©¤ë²„ ì´ë¦„">
                </div>
                <div class="form-group">
                    <label class="form-label">ì„±ë³„ *</label>
                    <select name="gender" class="form-control" required>
                        {% for value, label in gender_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">êµ¬ë ¥ (ë…„)</label>
                    <input type="number" name="experience_years" class="form-control" value="0" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">NTRP</label>
                    <select name="ntrp" class="form-control">
                        {% for value, label in ntrp_choices %}
                        <option value="{{ value }}" {% if value == '2.5' %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒíƒœ</label>
                    <select name="status" class="form-control">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ì—°ë½ì²˜</label>
                    <input type="text" name="phone" class="form-control" placeholder="010-0000-0000">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_admin">
                        <span>ğŸ‘‘ ìš´ì˜ì§„ìœ¼ë¡œ ì§€ì •</span>
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('addMemberModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitAddMember()">ì¶”ê°€í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ë©¤ë²„ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editMemberModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">âœï¸ ë©¤ë²„ ì •ë³´ ìˆ˜ì •</h3>
            <button class="modal-close" onclick="closeModal('editMemberModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="editMemberForm">
                <input type="hidden" name="member_id" id="editMemberId">
                <div class="form-group">
                    <label class="form-label">ì´ë¦„ *</label>
                    <input type="text" name="name" id="editName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ì„±ë³„ *</label>
                    <select name="gender" id="editGender" class="form-control" required>
                        {% for value, label in gender_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">êµ¬ë ¥ (ë…„)</label>
                    <input type="number" name="experience_years" id="editExperience" class="form-control" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">NTRP</label>
                    <select name="ntrp" id="editNtrp" class="form-control">
                        {% for value, label in ntrp_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ìƒíƒœ</label>
                    <select name="status" id="editStatus" class="form-control">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ì—°ë½ì²˜</label>
                    <input type="text" name="phone" id="editPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="is_admin" id="editIsAdmin">
                        <span>ğŸ‘‘ ìš´ì˜ì§„ìœ¼ë¡œ ì§€ì •</span>
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('editMemberModal')">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="submitEditMember()">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ë©¤ë²„ ìƒì„¸/í†µê³„ ëª¨ë‹¬ -->
<div id="memberDetailModal" class="modal-overlay">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title" id="memberDetailTitle">ğŸ“Š ë©¤ë²„ ìƒì„¸ ì •ë³´</h3>
            <button class="modal-close" onclick="closeModal('memberDetailModal')">Ã—</button>
        </div>
        <div class="modal-body" id="memberDetailContent">
            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('memberDetailModal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const targetId = tab.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = content.id === targetId ? 'block' : 'none';
        });
    });
});

// View member detail with stats
async function viewMemberDetail(memberId) {
    try {
        const response = await fetch(`/members/api/detail/${memberId}/`);
        const member = await response.json();
        
        document.getElementById('memberDetailTitle').textContent = `ğŸ“Š ${member.name} ë‹˜ì˜ ì •ë³´`;
        
        // ì°¸ì„ë¥  ìƒ‰ìƒ ê²°ì •
        let rateColor = '#28a745'; // ë…¹ìƒ‰
        if (member.stats.attendance_rate < 50) {
            rateColor = '#dc3545'; // ë¹¨ê°„ìƒ‰
        } else if (member.stats.attendance_rate < 70) {
            rateColor = '#ffc107'; // ë…¸ë€ìƒ‰
        }
        
        // ì›”ë³„ í†µê³„ HTML
        let monthlyStatsHtml = '';
        if (member.stats.monthly_stats && member.stats.monthly_stats.length > 0) {
            monthlyStatsHtml = member.stats.monthly_stats.map(m => `
                <div class="monthly-stat-item">
                    <span class="monthly-stat-month">${m.month}</span>
                    <div class="monthly-stat-bar-container">
                        <div class="monthly-stat-bar" style="width: ${m.rate}%; background-color: ${m.rate >= 70 ? '#28a745' : m.rate >= 50 ? '#ffc107' : '#dc3545'};"></div>
                    </div>
                    <span class="monthly-stat-value">${m.attended}/${m.total} (${m.rate}%)</span>
                </div>
            `).join('');
        }
        
        // ìµœê·¼ ì°¸ì„ ì¼ì • HTML
        let recentEventsHtml = '<span style="color: #888;">ì°¸ì„í•œ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</span>';
        if (member.stats.recent_events && member.stats.recent_events.length > 0) {
            recentEventsHtml = member.stats.recent_events.map(e => `
                <div class="recent-event-item">
                    <span class="recent-event-date">${e.date}</span>
                    <span class="recent-event-title">${e.title}</span>
                </div>
            `).join('');
        }
        
        document.getElementById('memberDetailContent').innerHTML = `
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="member-detail-section">
                <h4 class="section-title">ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h4>
                <div class="member-details" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="member-detail-item">
                        <div class="member-detail-label">ì„±ë³„</div>
                        <div class="member-detail-value">${member.gender_display}</div>
                    </div>
                    <div class="member-detail-item">
                        <div class="member-detail-label">êµ¬ë ¥</div>
                        <div class="member-detail-value">${member.experience_years}ë…„</div>
                    </div>
                    <div class="member-detail-item">
                        <div class="member-detail-label">NTRP</div>
                        <div class="member-detail-value">${member.ntrp}</div>
                    </div>
                    <div class="member-detail-item">
                        <div class="member-detail-label">ìƒíƒœ</div>
                        <div class="member-detail-value">${member.status_display}</div>
                    </div>
                </div>
            </div>
            
            <!-- ì°¸ì„ë¥  í†µê³„ -->
            <div class="member-detail-section" style="margin-top: 20px;">
                <h4 class="section-title">ğŸ“ˆ ì°¸ì„ë¥  í†µê³„</h4>
                <div class="attendance-stats">
                    <div class="attendance-main">
                        <div class="attendance-rate-circle" style="border-color: ${rateColor};">
                            <span class="rate-number" style="color: ${rateColor};">${member.stats.attendance_rate}%</span>
                            <span class="rate-label">ì°¸ì„ë¥ </span>
                        </div>
                        <div class="attendance-details">
                            <div class="stat-item">
                                <span class="stat-label">ì „ì²´ ì¼ì •</span>
                                <span class="stat-value">${member.stats.total_events}íšŒ</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ì°¸ì„í•œ ì¼ì •</span>
                                <span class="stat-value">${member.stats.attended_count}íšŒ</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ì—°ì† ì°¸ì„</span>
                                <span class="stat-value">${member.stats.consecutive_count}íšŒ ğŸ”¥</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì›”ë³„ ì°¸ì„ë¥  -->
            <div class="member-detail-section" style="margin-top: 20px;">
                <h4 class="section-title">ğŸ“… ìµœê·¼ 3ê°œì›” ì°¸ì„ë¥ </h4>
                <div class="monthly-stats">
                    ${monthlyStatsHtml || '<span style="color: #888;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</span>'}
                </div>
            </div>
            
            <!-- ìµœê·¼ ì°¸ì„ ì¼ì • -->
            <div class="member-detail-section" style="margin-top: 20px;">
                <h4 class="section-title">ğŸ¾ ìµœê·¼ ì°¸ì„í•œ ì¼ì •</h4>
                <div class="recent-events">
                    ${recentEventsHtml}
                </div>
            </div>
        `;
        
        openModal('memberDetailModal');
    } catch (error) {
        console.error('Error:', error);
        showToast('ë©¤ë²„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
    }
}

// Add member
async function submitAddMember() {
    const form = document.getElementById('addMemberForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    // ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
    data.is_admin = form.querySelector('input[name="is_admin"]').checked;
    
    try {
        const result = await fetchWithCSRF('/members/api/create/', {
            method: 'POST',
            body: JSON.stringify(data),
        });
        
        if (result.success) {
            showToast('ë©¤ë²„ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
            closeModal('addMemberModal');
            location.reload();
        } else {
            showToast(result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// Edit member
function editMember(id, name, gender, experience, ntrp, status, phone, isAdmin) {
    document.getElementById('editMemberId').value = id;
    document.getElementById('editName').value = name;
    document.getElementById('editGender').value = gender;
    document.getElementById('editExperience').value = experience;
    document.getElementById('editNtrp').value = ntrp;
    document.getElementById('editStatus').value = status;
    document.getElementById('editPhone').value = phone;
    document.getElementById('editIsAdmin').checked = isAdmin;
    openModal('editMemberModal');
}

async function submitEditMember() {
    const form = document.getElementById('editMemberForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    const memberId = data.member_id;
    delete data.member_id;
    // ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
    data.is_admin = document.getElementById('editIsAdmin').checked;
    
    try {
        const result = await fetchWithCSRF(`/members/api/update/${memberId}/`, {
            method: 'POST',
            body: JSON.stringify(data),
        });
        
        if (result.success) {
            showToast('ë©¤ë²„ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
            closeModal('editMemberModal');
            location.reload();
        } else {
            showToast(result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// Delete member
async function deleteMember(id, name) {
    if (!confirm(`ì •ë§ "${name}" ë©¤ë²„ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        const result = await fetchWithCSRF(`/members/api/delete/${id}/`, {
            method: 'POST',
        });
        
        if (result.success) {
            showToast('ë©¤ë²„ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            location.reload();
        } else {
            showToast(result.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}
</script>
{% endblock %}

