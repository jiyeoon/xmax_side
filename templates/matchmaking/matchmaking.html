{% extends 'base.html' %}

{% block title %}ëŒ€ì§„í‘œ - í…Œë‹ˆìŠ¤ í´ëŸ½{% endblock %}

{% block page_title %}ëŒ€ì§„í‘œ ìƒì„±{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="card-title" style="margin: 0;">ğŸ‘¥ ì°¸ê°€ì ì„ íƒ</h3>
        <button class="btn btn-secondary btn-sm" onclick="resetSelection()" style="font-size: 12px; padding: 6px 12px;">
            ğŸ”„ ì´ˆê¸°í™”
        </button>
    </div>
    <div class="card-body">
        <!-- ë©¤ë²„ ì„ íƒ -->
        <div class="section-title">ğŸ¾ í´ëŸ½ ë©¤ë²„</div>
        <div class="participant-grid" id="memberSelection">
            {% for member in members %}
            <div class="participant-card" data-member-id="{{ member.id }}" data-name="{{ member.name }}" data-ntrp="{{ member.ntrp }}" data-gender="{{ member.gender }}" onclick="toggleMember(this)">
                <div class="participant-name">{{ member.name }}</div>
                <div class="participant-info">{{ member.get_gender_display }} | NTRP {{ member.ntrp }}</div>
                <div class="timing-select" style="margin-top: 10px; display: none;">
                    <div class="timing-buttons">
                        <button type="button" class="timing-btn active" data-value="full" onclick="event.stopPropagation(); selectTiming(this)">ì „ì²´ì°¸ì„</button>
                        <button type="button" class="timing-btn" data-value="late" onclick="event.stopPropagation(); selectTiming(this)">30ë¶„ ëŠ¦ì°¸</button>
                        <button type="button" class="timing-btn" data-value="early" onclick="event.stopPropagation(); selectTiming(this)">30ë¶„ ì¼í‡´</button>
                    </div>
                    <input type="hidden" class="timing-value" value="full">
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- ê²ŒìŠ¤íŠ¸ ì¶”ê°€ -->
        <div class="section-title" style="margin-top: 24px;">ğŸ™‹ ê²ŒìŠ¤íŠ¸ ì¶”ê°€</div>
        <div class="guest-list" id="guestList">
            <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
        </div>
        <button class="btn btn-secondary" onclick="addGuest()">
            â• ê²ŒìŠ¤íŠ¸ ì¶”ê°€
        </button>
    </div>
</div>

<!-- ì„¤ì • -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h3 class="card-title">âš™ï¸ ëŒ€ì§„ ì„¤ì •</h3>
    </div>
    <div class="card-body">
        <!-- ì°¸ê°€ì í˜„í™© -->
        <div class="participant-summary" id="participantSummary">
            <div class="summary-item total">
                <span class="summary-icon">ğŸ‘¥</span>
                <span class="summary-label">ì´ ì¸ì›</span>
                <span class="summary-value" id="totalCount">0ëª…</span>
            </div>
            <div class="summary-item male">
                <span class="summary-icon">ğŸ™‹â€â™‚ï¸</span>
                <span class="summary-label">ë‚¨ì</span>
                <span class="summary-value" id="maleCount">0ëª…</span>
            </div>
            <div class="summary-item female">
                <span class="summary-icon">ğŸ™‹â€â™€ï¸</span>
                <span class="summary-label">ì—¬ì</span>
                <span class="summary-value" id="femaleCount">0ëª…</span>
            </div>
        </div>
        
        <div class="settings-row">
            <div class="setting-item">
                <label>ğŸ“… ë‚ ì§œ:</label>
                <input type="date" id="matchDate" class="form-control" style="min-width: 150px;">
            </div>
            <div class="setting-item">
                <label>ì½”íŠ¸ ìˆ˜:</label>
                <input type="number" id="numCourts" class="form-control" value="2" min="1" max="10">
            </div>
            <div class="setting-item">
                <label>ë¼ìš´ë“œ ìˆ˜:</label>
                <input type="number" id="numRounds" class="form-control" value="6" min="1" max="20">
            </div>
        </div>
        <div class="settings-row">
            <button class="btn btn-primary" onclick="generateMatches()">
                ğŸ¯ ëŒ€ì§„í‘œ ìƒì„±
            </button>
            <button class="btn btn-secondary" id="regenerateBtn" onclick="regenerateMatches()" style="display: none;">
                ğŸ”„ ë‹¤ì‹œ ìƒì„±
            </button>
        </div>
    </div>
</div>

<!-- ëŒ€ì§„í‘œ ê²°ê³¼ -->
<div id="matchResult" style="display: none;">
    <!-- ê²Œì„ ìˆ˜ í†µê³„ -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h3 class="card-title">ğŸ“ˆ ì°¸ê°€ìë³„ ê²Œì„ ìˆ˜ í†µê³„</h3>
        </div>
        <div class="card-body">
            <div class="table-wrapper">
                <table class="stats-table" id="statsTable">
                    <thead>
                        <tr>
                            <th>ì°¸ê°€ì</th>
                            <th>ì „ì²´</th>
                            <th>ğŸ‘¬ ë‚¨ë³µ</th>
                            <th>ğŸ‘­ ì—¬ë³µ</th>
                            <th>ğŸ‘« í˜¼ë³µ</th>
                            <th>ğŸ˜´ íœ´ì‹</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs" style="margin-bottom: 20px;">
        <button class="tab active" data-tab="table-view">ğŸ“Š í‘œ ë·°</button>
        <button class="tab" data-tab="card-view">ğŸ“‹ ì¹´ë“œ ë·°</button>
    </div>

    <!-- í‘œ ë·° -->
    <div id="table-view" class="tab-content">
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title">ğŸ“Š ëŒ€ì§„í‘œ ìš”ì•½</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary btn-sm" onclick="openEditModal()">
                        âœï¸ ìˆ˜ì •
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadTableAsImage()">
                        ğŸ“¥ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="scheduleTableWrapper">
                    <div id="scheduleTableContainer">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¹´ë“œ ë·° -->
    <div id="card-view" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">ğŸ“‹ ëŒ€ì§„í‘œ</h3>
            </div>
            <div class="card-body">
                <div class="match-schedule" id="matchSchedule">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- html2canvas for image download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let selectedMembers = [];
let guests = [];
let currentSessionId = null;
let currentSchedule = null; // í˜„ì¬ ìŠ¤ì¼€ì¤„ ì €ì¥

// ===== localStorage ì €ì¥/ë³µì› =====
const STORAGE_KEY = 'matchmaking_data';

function saveToStorage() {
    const data = {
        selectedMembers: [],
        guests: []
    };
    
    // ì„ íƒëœ ë©¤ë²„ ì €ì¥
    document.querySelectorAll('.participant-card.selected').forEach(card => {
        const timing = card.querySelector('.timing-value')?.value || 'full';
        data.selectedMembers.push({
            id: card.dataset.memberId,
            timing: timing
        });
    });
    
    // ê²ŒìŠ¤íŠ¸ ì €ì¥
    document.querySelectorAll('.guest-item').forEach(item => {
        const name = item.querySelector('.guest-name')?.value || '';
        const gender = item.querySelector('.guest-gender')?.value || 'M';
        const ntrp = item.querySelector('.guest-ntrp')?.value || '2.5';
        const timing = item.querySelector('.guest-timing')?.value || 'full';
        
        if (name) {
            data.guests.push({ name, gender, ntrp, timing });
        }
    });
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function loadFromStorage() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return;
    
    try {
        const data = JSON.parse(stored);
        
        // ë©¤ë²„ ì„ íƒ ë³µì›
        if (data.selectedMembers) {
            data.selectedMembers.forEach(member => {
                const card = document.querySelector(`.participant-card[data-member-id="${member.id}"]`);
                if (card) {
                    card.classList.add('selected');
                    const timingSelect = card.querySelector('.timing-select');
                    if (timingSelect) {
                        timingSelect.style.display = 'block';
                        // íƒ€ì´ë° ë²„íŠ¼ ë³µì›
                        const timingBtn = card.querySelector(`.timing-btn[data-value="${member.timing}"]`);
                        if (timingBtn) {
                            card.querySelectorAll('.timing-btn').forEach(b => b.classList.remove('active'));
                            timingBtn.classList.add('active');
                            const hiddenInput = card.querySelector('.timing-value');
                            if (hiddenInput) hiddenInput.value = member.timing;
                        }
                    }
                }
            });
        }
        
        // ê²ŒìŠ¤íŠ¸ ë³µì›
        if (data.guests && data.guests.length > 0) {
            data.guests.forEach(guest => {
                addGuestWithData(guest);
            });
        }
        
        // ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
        updateParticipantCount();
    } catch (e) {
        console.error('Failed to load from storage:', e);
    }
}

function clearStorage() {
    localStorage.removeItem(STORAGE_KEY);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë³µì›
document.addEventListener('DOMContentLoaded', function() {
    loadFromStorage();
});

// ===== ê¸°ì¡´ í•¨ìˆ˜ë“¤ =====

// ë©¤ë²„ ì„ íƒ í† ê¸€
function toggleMember(card) {
    card.classList.toggle('selected');
    const timingSelect = card.querySelector('.timing-select');
    
    if (card.classList.contains('selected')) {
        timingSelect.style.display = 'block';
    } else {
        timingSelect.style.display = 'none';
    }
    
    // ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
    updateParticipantCount();
    
    // localStorageì— ì €ì¥
    saveToStorage();
}

// íƒ€ì´ë° ë²„íŠ¼ ì„ íƒ
function selectTiming(btn) {
    const container = btn.closest('.timing-buttons');
    container.querySelectorAll('.timing-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    // hidden inputì— ê°’ ì €ì¥
    const hiddenInput = btn.closest('.timing-select').querySelector('.timing-value');
    hiddenInput.value = btn.dataset.value;
    
    // localStorageì— ì €ì¥
    saveToStorage();
}

// ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
function updateParticipantCount() {
    let total = 0;
    let male = 0;
    let female = 0;
    
    // ì„ íƒëœ ë©¤ë²„ ì¹´ìš´íŠ¸
    document.querySelectorAll('.participant-card.selected').forEach(card => {
        total++;
        if (card.dataset.gender === 'M') {
            male++;
        } else {
            female++;
        }
    });
    
    // ê²ŒìŠ¤íŠ¸ ì¹´ìš´íŠ¸
    document.querySelectorAll('.guest-item').forEach(item => {
        const name = item.querySelector('.guest-name').value;
        if (name) {
            total++;
            const gender = item.querySelector('.guest-gender').value;
            if (gender === 'M') {
                male++;
            } else {
                female++;
            }
        }
    });
    
    // UI ì—…ë°ì´íŠ¸
    document.getElementById('totalCount').textContent = `${total}ëª…`;
    document.getElementById('maleCount').textContent = `${male}ëª…`;
    document.getElementById('femaleCount').textContent = `${female}ëª…`;
    
    // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ (ì¸ì›ì— ë”°ë¼)
    const summaryEl = document.getElementById('participantSummary');
    if (total >= 4) {
        summaryEl.classList.add('ready');
        summaryEl.classList.remove('not-ready');
    } else {
        summaryEl.classList.add('not-ready');
        summaryEl.classList.remove('ready');
    }
}

// ê²ŒìŠ¤íŠ¸ ì¶”ê°€
let guestCount = 0;
function addGuest() {
    guestCount++;
    const guestHtml = `
        <div class="guest-item" id="guest-${guestCount}">
            <div class="form-group">
                <label class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control guest-name" placeholder="ê²ŒìŠ¤íŠ¸ ì´ë¦„" onchange="updateParticipantCount(); saveToStorage();">
            </div>
            <div class="form-group">
                <label class="form-label">ì„±ë³„</label>
                <select class="form-control guest-gender" onchange="updateParticipantCount(); saveToStorage();">
                    <option value="M">ë‚¨ì„±</option>
                    <option value="F">ì—¬ì„±</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">NTRP</label>
                <select class="form-control guest-ntrp" onchange="saveToStorage();">
                    {% for value, label in ntrp_choices %}
                    <option value="{{ value }}" {% if value == '2.5' %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ì°¸ì„</label>
                <select class="form-control guest-timing" onchange="saveToStorage();">
                    <option value="full">ì „ì²´ì°¸ì„</option>
                    <option value="late">30ë¶„ ëŠ¦ì°¸</option>
                    <option value="early">30ë¶„ ì¼í‡´</option>
                </select>
            </div>
            <button class="btn btn-danger btn-sm" onclick="removeGuest(${guestCount})">ğŸ—‘ï¸</button>
        </div>
    `;
    document.getElementById('guestList').insertAdjacentHTML('beforeend', guestHtml);
    updateParticipantCount();
    saveToStorage();
}

// ë°ì´í„°ì™€ í•¨ê»˜ ê²ŒìŠ¤íŠ¸ ì¶”ê°€ (ë³µì›ìš©)
function addGuestWithData(guest) {
    guestCount++;
    const guestHtml = `
        <div class="guest-item" id="guest-${guestCount}">
            <div class="form-group">
                <label class="form-label">ì´ë¦„</label>
                <input type="text" class="form-control guest-name" placeholder="ê²ŒìŠ¤íŠ¸ ì´ë¦„" onchange="updateParticipantCount(); saveToStorage();">
            </div>
            <div class="form-group">
                <label class="form-label">ì„±ë³„</label>
                <select class="form-control guest-gender" onchange="updateParticipantCount(); saveToStorage();">
                    <option value="M">ë‚¨ì„±</option>
                    <option value="F">ì—¬ì„±</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">NTRP</label>
                <select class="form-control guest-ntrp" onchange="saveToStorage();">
                    {% for value, label in ntrp_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ì°¸ì„</label>
                <select class="form-control guest-timing" onchange="saveToStorage();">
                    <option value="full">ì „ì²´ì°¸ì„</option>
                    <option value="late">30ë¶„ ëŠ¦ì°¸</option>
                    <option value="early">30ë¶„ ì¼í‡´</option>
                </select>
            </div>
            <button class="btn btn-danger btn-sm" onclick="removeGuest(${guestCount})">ğŸ—‘ï¸</button>
        </div>
    `;
    document.getElementById('guestList').insertAdjacentHTML('beforeend', guestHtml);
    
    // ê°’ ì§ì ‘ ì„¤ì •
    const lastGuest = document.getElementById(`guest-${guestCount}`);
    if (lastGuest) {
        if (guest.name) lastGuest.querySelector('.guest-name').value = guest.name;
        if (guest.gender) lastGuest.querySelector('.guest-gender').value = guest.gender;
        if (guest.ntrp) lastGuest.querySelector('.guest-ntrp').value = guest.ntrp;
        if (guest.timing) lastGuest.querySelector('.guest-timing').value = guest.timing;
    }
}

function removeGuest(id) {
    document.getElementById(`guest-${id}`).remove();
    updateParticipantCount();
    saveToStorage();
}

// ì„ íƒ ì´ˆê¸°í™”
function resetSelection() {
    if (!confirm('ì„ íƒëœ ëª¨ë“  ë©¤ë²„ì™€ ê²ŒìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) {
        return;
    }
    
    // ë©¤ë²„ ì„ íƒ í•´ì œ
    document.querySelectorAll('.participant-card.selected').forEach(card => {
        card.classList.remove('selected');
        // íƒ€ì´ë° ì„ íƒ ìˆ¨ê¸°ê¸° & ì´ˆê¸°í™”
        const timingSelect = card.querySelector('.timing-select');
        if (timingSelect) {
            timingSelect.style.display = 'none';
            // íƒ€ì´ë° ê°’ ì´ˆê¸°í™”
            const timingValue = timingSelect.querySelector('.timing-value');
            if (timingValue) timingValue.value = 'full';
            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™” (ì „ì²´ì°¸ì„ë§Œ í™œì„±í™”)
            timingSelect.querySelectorAll('.timing-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.value === 'full');
            });
        }
    });
    
    // ê²ŒìŠ¤íŠ¸ ëª©ë¡ ë¹„ìš°ê¸°
    document.getElementById('guestList').innerHTML = '';
    guestCount = 0;
    
    // localStorage ì´ˆê¸°í™”
    localStorage.removeItem(STORAGE_KEY);
    
    // ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸
    updateParticipantCount();
    
    // ì•Œë¦¼
    showToast('âœ… ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
}

// ì°¸ê°€ì ë°ì´í„° ìˆ˜ì§‘
function collectParticipants() {
    const participants = [];
    const numRounds = parseInt(document.getElementById('numRounds').value);
    
    // ì„ íƒëœ ë©¤ë²„
    document.querySelectorAll('.participant-card.selected').forEach(card => {
        const timingInput = card.querySelector('.timing-value');
        const timing = timingInput ? timingInput.value : 'full';
        
        // 30ë¶„ ëŠ¦ì°¸ = 2ë¼ìš´ë“œë¶€í„°, 30ë¶„ ì¼í‡´ = ë§ˆì§€ë§‰-1 ë¼ìš´ë“œê¹Œì§€
        let startRound = 1;
        let endRound = numRounds;
        
        if (timing === 'late') {
            startRound = 2;
        } else if (timing === 'early') {
            endRound = Math.max(1, numRounds - 1);
        }
        
        participants.push({
            member_id: parseInt(card.dataset.memberId),
            name: card.dataset.name,
            gender: card.dataset.gender,
            timing: timing,
            start_round: startRound,
            end_round: endRound,
        });
    });
    
    // ê²ŒìŠ¤íŠ¸
    document.querySelectorAll('.guest-item').forEach(item => {
        const name = item.querySelector('.guest-name').value;
        if (name) {
            const timing = item.querySelector('.guest-timing').value;
            
            let startRound = 1;
            let endRound = numRounds;
            
            if (timing === 'late') {
                startRound = 2;
            } else if (timing === 'early') {
                endRound = Math.max(1, numRounds - 1);
            }
            
            participants.push({
                name: name,
                gender: item.querySelector('.guest-gender').value,
                ntrp: item.querySelector('.guest-ntrp').value,
                timing: timing,
                start_round: startRound,
                end_round: endRound,
            });
        }
    });
    
    return participants;
}

// ëŒ€ì§„í‘œ ìƒì„±
async function generateMatches() {
    const participants = collectParticipants();
    
    if (participants.length < 4) {
        showToast('ìµœì†Œ 4ëª…ì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const result = await fetchWithCSRF('/matchmaking/api/generate/', {
            method: 'POST',
            body: JSON.stringify({
                participants: participants,
                num_courts: parseInt(document.getElementById('numCourts').value),
                num_rounds: parseInt(document.getElementById('numRounds').value),
                date: new Date().toISOString().split('T')[0],
            }),
        });
        
        hideLoading();
        
        if (result.success) {
            currentSessionId = result.session_id;
            displaySchedule(result.schedule);
            document.getElementById('matchResult').style.display = 'block';
            document.getElementById('regenerateBtn').style.display = 'inline-flex';
            showToast('ëŒ€ì§„í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¾');
            
            // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
            document.getElementById('matchResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            showToast(result.error || 'ëŒ€ì§„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        hideLoading();
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        console.error(error);
    }
}

// ëŒ€ì§„í‘œ ì¬ìƒì„±
async function regenerateMatches() {
    if (!currentSessionId) {
        showToast('ë¨¼ì € ëŒ€ì§„í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”', 'error');
        return;
    }
    
    showLoading();
    
    try {
        const result = await fetchWithCSRF('/matchmaking/api/regenerate/', {
            method: 'POST',
            body: JSON.stringify({
                session_id: currentSessionId,
                num_courts: parseInt(document.getElementById('numCourts').value),
                num_rounds: parseInt(document.getElementById('numRounds').value),
            }),
        });
        
        hideLoading();
        
        if (result.success) {
            displaySchedule(result.schedule);
            showToast('ìƒˆë¡œìš´ ëŒ€ì§„í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”„');
        } else {
            showToast(result.error || 'ëŒ€ì§„í‘œ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        hideLoading();
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// ëŒ€ì§„í‘œ í‘œì‹œ
function displaySchedule(schedule) {
    currentSchedule = schedule; // ìŠ¤ì¼€ì¤„ ì €ì¥
    
    // ì¹´ë“œ ë·° í‘œì‹œ
    const container = document.getElementById('matchSchedule');
    container.innerHTML = '';
    
    schedule.forEach(round => {
        let matchesHtml = round.matches.map(match => {
            // ë§¤ì¹˜ íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤
            const typeClass = match.match_type ? `match-type-${match.match_type.type}` : '';
            const typeLabel = match.match_type ? match.match_type.label : '';
            const typeEmoji = match.match_type ? match.match_type.emoji : '';
            
            return `
            <div class="match-item ${typeClass}">
                <div class="match-badges">
                    <div class="court-badge">ì½”íŠ¸ ${match.court}</div>
                    <div class="match-type-badge ${typeClass}">${typeEmoji} ${typeLabel}</div>
                </div>
                <div class="match-teams">
                    <div class="team">
                        <div class="team-players">${match.team_a.join(' & ')}</div>
                        <div class="team-ntrp">NTRP: ${match.team_a_ntrp.join(' + ')}</div>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="team">
                        <div class="team-players">${match.team_b.join(' & ')}</div>
                        <div class="team-ntrp">NTRP: ${match.team_b_ntrp.join(' + ')}</div>
                    </div>
                </div>
            </div>
        `}).join('');
        
        let restingHtml = '';
        if (round.resting && round.resting.length > 0) {
            restingHtml = `
                <div class="resting-section">
                    <strong>ğŸ˜´ íœ´ì‹:</strong> ${round.resting.join(', ')}
                </div>
            `;
        }
        
        const roundHtml = `
            <div class="round-card">
                <div class="round-header">ë¼ìš´ë“œ ${round.round}</div>
                <div class="match-list">
                    ${matchesHtml}
                </div>
                ${restingHtml}
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', roundHtml);
    });
    
    // í‘œ ë·°ë„ ìƒì„±
    displayScheduleTable(schedule);
    
    // ê²Œì„ ìˆ˜ í†µê³„ í‘œì‹œ
    displayGameStats(schedule);
}

// ê²Œì„ ìˆ˜ í†µê³„ ê³„ì‚° ë° í‘œì‹œ
function displayGameStats(schedule) {
    const stats = {}; // {name: {total: 0, male: 0, female: 0, mixed: 0, rest: 0}}
    
    // ëª¨ë“  ì°¸ê°€ì ì´ˆê¸°í™” (í”Œë ˆì´í•œ ì‚¬ëŒ + íœ´ì‹í•œ ì‚¬ëŒ)
    schedule.forEach(round => {
        // í”Œë ˆì´í•œ ì‚¬ëŒë“¤
        round.matches.forEach(match => {
            const matchType = match.match_type ? match.match_type.type : 'mixed';
            const allPlayers = [...match.team_a, ...match.team_b];
            
            allPlayers.forEach(playerName => {
                if (!stats[playerName]) {
                    stats[playerName] = { total: 0, male: 0, female: 0, mixed: 0, rest: 0 };
                }
                stats[playerName].total++;
                stats[playerName][matchType]++;
            });
        });
        
        // íœ´ì‹í•œ ì‚¬ëŒë“¤
        if (round.resting && round.resting.length > 0) {
            round.resting.forEach(playerName => {
                if (!stats[playerName]) {
                    stats[playerName] = { total: 0, male: 0, female: 0, mixed: 0, rest: 0 };
                }
                stats[playerName].rest++;
            });
        }
    });
    
    // í…Œì´ë¸” ìƒì„±
    const tbody = document.getElementById('statsTableBody');
    tbody.innerHTML = '';
    
    // ì •ë ¬ (ì „ì²´ ê²Œì„ ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ)
    const sortedPlayers = Object.entries(stats).sort((a, b) => b[1].total - a[1].total);
    
    sortedPlayers.forEach(([name, data]) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="player-name-cell">${name}</td>
            <td class="stats-cell total-cell"><strong>${data.total}</strong></td>
            <td class="stats-cell male-cell">${data.male}</td>
            <td class="stats-cell female-cell">${data.female}</td>
            <td class="stats-cell mixed-cell">${data.mixed}</td>
            <td class="stats-cell rest-cell">${data.rest}</td>
        `;
        tbody.appendChild(row);
    });
}

// í‘œ í˜•ì‹ ëŒ€ì§„í‘œ ìƒì„±
function displayScheduleTable(schedule) {
    const tableContainer = document.getElementById('scheduleTableContainer');
    
    // ì½”íŠ¸ ìˆ˜ ê³„ì‚°
    const numCourts = Math.max(...schedule.flatMap(r => r.matches.map(m => m.court)));
    
    // ë‚ ì§œ (ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸°)
    const dateInput = document.getElementById('matchDate').value;
    let dateStr;
    if (dateInput) {
        const [year, month, day] = dateInput.split('-');
        dateStr = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
    } else {
        const today = new Date();
        dateStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;
    }
    
    let tableHtml = `
        <div class="schedule-table-header">
            <div class="schedule-title">ğŸ¾ í—˜ë¸”ë¹„ í…Œë‹ˆìŠ¤ í´ëŸ½ ëŒ€ì§„í‘œ</div>
            <div class="schedule-date">${dateStr}</div>
        </div>
        <table class="schedule-table">
            <thead>
                <tr>
                    <th class="round-col">ë¼ìš´ë“œ</th>
    `;
    
    // ì½”íŠ¸ë³„ í—¤ë”
    for (let i = 1; i <= numCourts; i++) {
        tableHtml += `<th class="court-col">ì½”íŠ¸ ${i}</th>`;
    }
    tableHtml += `<th class="rest-col">íœ´ì‹</th></tr></thead><tbody>`;
    
    // ê° ë¼ìš´ë“œ í–‰
    schedule.forEach(round => {
        tableHtml += `<tr><td class="round-cell"><strong>R${round.round}</strong></td>`;
        
        // ê° ì½”íŠ¸ë³„ ë§¤ì¹˜
        for (let court = 1; court <= numCourts; court++) {
            const match = round.matches.find(m => m.court === court);
            if (match) {
                const typeClass = match.match_type ? match.match_type.type : '';
                const typeLabel = match.match_type ? match.match_type.label : '';
                const typeEmoji = match.match_type ? match.match_type.emoji : '';
                
                tableHtml += `
                    <td class="match-cell match-cell-${typeClass}">
                        <div class="table-match-type">${typeEmoji} ${typeLabel}</div>
                        <div class="table-team">${match.team_a.join(' & ')}</div>
                        <div class="table-vs">VS</div>
                        <div class="table-team">${match.team_b.join(' & ')}</div>
                    </td>
                `;
            } else {
                tableHtml += `<td class="match-cell empty-cell">-</td>`;
            }
        }
        
        // íœ´ì‹ ë©¤ë²„
        const resting = round.resting && round.resting.length > 0 
            ? round.resting.join(', ') 
            : '-';
        tableHtml += `<td class="rest-cell">${resting}</td></tr>`;
    });
    
    tableHtml += `</tbody></table>`;
    
    // ìš´ì˜ ë°©ì‹ ì•ˆë‚´
    tableHtml += `
        <div class="operation-guide">
            <div class="guide-title">ğŸ¾ í—˜ë¸”ë¹„ ì¼ìš”ì •ëª¨ ìš´ì˜ ë°©ì‹</div>
            <div class="guide-content">
                <p>1. ê° Set ì‚¬ì´ ì‰¬ëŠ”ì‹œê°„ 3ë¶„ (Set ì¢…ë£Œ í›„ ë‹¤ìŒ ê²Œì„ Player ë°”ë¡œ ë‚˜ê°ˆ ìˆ˜ ìˆë„ë¡ ì¤€ë¹„)</p>
                <p>2. Set ì¢…ë£Œ ì‹œì ì€ ë‘˜ ì¤‘ í•˜ë‚˜ ì¶©ì¡±ì‹œ ì¢…ë£Œ (6ê²Œì„ ìŠ¹ or ê²Œì„ì‹œê°„ ì¢…ë£Œ)</p>
                <p>3. ê²Œì„ 5:5 ê²½ìš° ê²Œì„ì‹œê°„ 5ë¶„ ì´ˆê³¼ ì—¬ìœ ì‹œ Tie Break / 5ë¶„ ì´í•˜ 1ê²Œì„ìœ¼ë¡œ ì§„í–‰</p>
                <p>4. ë“€ìŠ¤ X ë…¸ì—ë“œ ì§„í–‰</p>
            </div>
        </div>
    `;
    
    tableContainer.innerHTML = tableHtml;
}

// íƒ­ ì „í™˜ ë° URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
    // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('#matchResult .tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // íƒ­ í™œì„±í™”
            document.querySelectorAll('#matchResult .tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // ì½˜í…ì¸  ì „í™˜
            const targetId = this.dataset.tab;
            document.querySelectorAll('#matchResult .tab-content').forEach(content => {
                content.style.display = content.id === targetId ? 'block' : 'none';
            });
        });
    });
    
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„ íƒí•  ë©¤ë²„ ê°€ì ¸ì˜¤ê¸° (ì¼ì •ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš°)
    const urlParams = new URLSearchParams(window.location.search);
    const memberIdsParam = urlParams.get('members');
    const eventDate = urlParams.get('date');
    const eventTitle = urlParams.get('title');
    
    // ë‚ ì§œ í•„ë“œ ì´ˆê¸°í™” (ì˜¤ëŠ˜ ë‚ ì§œ ë˜ëŠ” URLì—ì„œ ë°›ì€ ë‚ ì§œ)
    const dateInput = document.getElementById('matchDate');
    if (eventDate) {
        dateInput.value = eventDate;
    } else {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    if (memberIdsParam) {
        const memberIds = memberIdsParam.split(',').map(id => parseInt(id));
        
        // 1. ë¨¼ì € ëª¨ë“  ê¸°ì¡´ ì„ íƒ ì´ˆê¸°í™”
        document.querySelectorAll('.participant-card.selected').forEach(card => {
            card.classList.remove('selected');
            const timingSelect = card.querySelector('.timing-select');
            if (timingSelect) {
                timingSelect.style.display = 'none';
                // íƒ€ì´ë°ë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë¦¬ì…‹
                const timingValue = timingSelect.querySelector('.timing-value');
                if (timingValue) timingValue.value = 'full';
                timingSelect.querySelectorAll('.timing-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.value === 'full');
                });
            }
        });
        
        // ê²ŒìŠ¤íŠ¸ë„ ì´ˆê¸°í™”
        document.getElementById('guestList').innerHTML = '';
        
        // 2. URLì— ìˆëŠ” ë©¤ë²„ë§Œ ìƒˆë¡œ ì„ íƒ
        document.querySelectorAll('.participant-card[data-member-id]').forEach(card => {
            const memberId = parseInt(card.dataset.memberId);
            if (memberIds.includes(memberId)) {
                card.classList.add('selected');
                const timingSelect = card.querySelector('.timing-select');
                if (timingSelect) {
                    timingSelect.style.display = 'block';
                }
            }
        });
        
        // 3. ì°¸ê°€ì ìˆ˜ ì—…ë°ì´íŠ¸ & ì €ì¥
        updateParticipantCount();
        saveToStorage();
        
        // ì¼ì • ì •ë³´ í‘œì‹œ
        if (eventDate || eventTitle) {
            const infoText = eventTitle ? `ğŸ“… ${eventTitle} (${eventDate})` : `ğŸ“… ${eventDate}`;
            showToast(`${infoText} ì°¸ì„ìê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        }
    }
});

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
async function downloadTableAsImage() {
    const tableWrapper = document.getElementById('scheduleTableContainer');
    
    if (!tableWrapper || !currentSchedule) {
        showToast('ëŒ€ì§„í‘œê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    showLoading();
    
    try {
        // ì´ë¯¸ì§€ ì €ì¥ì„ ìœ„í•´ ì„ì‹œë¡œ ë„ˆë¹„ ê³ ì • (800px)
        const originalStyle = tableWrapper.style.cssText;
        tableWrapper.style.cssText = 'width: 800px !important; min-width: 800px !important; max-width: 800px !important;';
        
        // ë¦¬í”Œë¡œìš° ëŒ€ê¸°
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const canvas = await html2canvas(tableWrapper, {
            backgroundColor: '#ffffff',
            scale: 2, // ê³ í•´ìƒë„
            useCORS: true,
            logging: false,
            width: 800,
        });
        
        // ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì›
        tableWrapper.style.cssText = originalStyle;
        
        // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const link = document.createElement('a');
        const today = new Date();
        const filename = `ëŒ€ì§„í‘œ_${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}.png`;
        
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        hideLoading();
        showToast('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¥');
    } catch (error) {
        hideLoading();
        showToast('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        console.error(error);
    }
}

// ===== ëŒ€ì§„í‘œ ìˆ˜ì • ê¸°ëŠ¥ =====

function openEditModal() {
    if (!currentSchedule || currentSchedule.length === 0) {
        showToast('ìˆ˜ì •í•  ëŒ€ì§„í‘œê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    // ì°¸ê°€ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const participants = [];
    document.querySelectorAll('.participant-card.selected').forEach(card => {
        participants.push({
            id: card.dataset.memberId,
            name: card.dataset.name,
            gender: card.dataset.gender
        });
    });
    document.querySelectorAll('.guest-item').forEach(item => {
        const name = item.querySelector('.guest-name').value;
        if (name) {
            participants.push({
                id: 'guest_' + name,
                name: name,
                gender: item.querySelector('.guest-gender').value
            });
        }
    });
    
    // ëª¨ë‹¬ ë‚´ìš© ìƒì„±
    let modalContent = '<div class="edit-schedule-content">';
    
    currentSchedule.forEach((round, roundIdx) => {
        modalContent += `<div class="edit-round">
            <h4>ğŸ¾ ë¼ìš´ë“œ ${round.round}</h4>
            <div class="edit-matches">`;
        
        round.matches.forEach((match, matchIdx) => {
            const teamA = match.team_a || [];
            const teamB = match.team_b || [];
            
            modalContent += `
            <div class="edit-match" data-round="${roundIdx}" data-match="${matchIdx}">
                <div class="edit-match-header">ì½”íŠ¸ ${match.court}</div>
                <div class="edit-teams">
                    <div class="edit-team">
                        <select class="form-control edit-player" data-team="a" data-pos="0">
                            <option value="">ì„ ìˆ˜ ì„ íƒ</option>
                            ${participants.map(p => `<option value="${p.name}" ${teamA[0] === p.name ? 'selected' : ''}>${p.name} (${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'})</option>`).join('')}
                        </select>
                        <select class="form-control edit-player" data-team="a" data-pos="1">
                            <option value="">ì„ ìˆ˜ ì„ íƒ</option>
                            ${participants.map(p => `<option value="${p.name}" ${teamA[1] === p.name ? 'selected' : ''}>${p.name} (${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'})</option>`).join('')}
                        </select>
                    </div>
                    <div class="edit-vs">VS</div>
                    <div class="edit-team">
                        <select class="form-control edit-player" data-team="b" data-pos="0">
                            <option value="">ì„ ìˆ˜ ì„ íƒ</option>
                            ${participants.map(p => `<option value="${p.name}" ${teamB[0] === p.name ? 'selected' : ''}>${p.name} (${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'})</option>`).join('')}
                        </select>
                        <select class="form-control edit-player" data-team="b" data-pos="1">
                            <option value="">ì„ ìˆ˜ ì„ íƒ</option>
                            ${participants.map(p => `<option value="${p.name}" ${teamB[1] === p.name ? 'selected' : ''}>${p.name} (${p.gender === 'M' ? 'ë‚¨' : 'ì—¬'})</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>`;
        });
        
        modalContent += '</div></div>';
    });
    
    modalContent += '</div>';
    
    // ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('editModalBody').innerHTML = modalContent;
    document.getElementById('editScheduleModal').style.display = 'flex';
}

function closeEditModal() {
    document.getElementById('editScheduleModal').style.display = 'none';
}

function saveScheduleEdits() {
    // ìˆ˜ì •ëœ ë‚´ìš©ì„ currentScheduleì— ë°˜ì˜
    document.querySelectorAll('.edit-match').forEach(matchEl => {
        const roundIdx = parseInt(matchEl.dataset.round);
        const matchIdx = parseInt(matchEl.dataset.match);
        
        const teamA = [
            matchEl.querySelector('[data-team="a"][data-pos="0"]').value,
            matchEl.querySelector('[data-team="a"][data-pos="1"]').value
        ].filter(v => v);
        
        const teamB = [
            matchEl.querySelector('[data-team="b"][data-pos="0"]').value,
            matchEl.querySelector('[data-team="b"][data-pos="1"]').value
        ].filter(v => v);
        
        if (currentSchedule[roundIdx] && currentSchedule[roundIdx].matches[matchIdx]) {
            currentSchedule[roundIdx].matches[matchIdx].team_a = teamA;
            currentSchedule[roundIdx].matches[matchIdx].team_b = teamB;
            
            // ë§¤ì¹˜ íƒ€ì… ì¬ê³„ì‚°
            const genders = [];
            [...teamA, ...teamB].forEach(name => {
                const card = document.querySelector(`.participant-card[data-name="${name}"]`);
                if (card) {
                    genders.push(card.dataset.gender);
                } else {
                    // ê²ŒìŠ¤íŠ¸ì¸ ê²½ìš°
                    document.querySelectorAll('.guest-item').forEach(item => {
                        if (item.querySelector('.guest-name').value === name) {
                            genders.push(item.querySelector('.guest-gender').value);
                        }
                    });
                }
            });
            
            const maleCount = genders.filter(g => g === 'M').length;
            const femaleCount = genders.filter(g => g === 'F').length;
            
            let matchType = { type: 'mixed', label: 'í˜¼ë³µ', emoji: 'ğŸ‘«' };
            if (maleCount === 4) matchType = { type: 'male', label: 'ë‚¨ë³µ', emoji: 'ğŸ‘¬' };
            else if (femaleCount === 4) matchType = { type: 'female', label: 'ì—¬ë³µ', emoji: 'ğŸ‘­' };
            
            currentSchedule[roundIdx].matches[matchIdx].match_type = matchType;
        }
    });
    
    // íœ´ì‹ ì¸ì› ì¬ê³„ì‚°
    currentSchedule.forEach(round => {
        const playingNames = new Set();
        round.matches.forEach(match => {
            [...(match.team_a || []), ...(match.team_b || [])].forEach(name => playingNames.add(name));
        });
        
        const allNames = [];
        document.querySelectorAll('.participant-card.selected').forEach(card => {
            allNames.push(card.dataset.name);
        });
        document.querySelectorAll('.guest-item').forEach(item => {
            const name = item.querySelector('.guest-name').value;
            if (name) allNames.push(name);
        });
        
        round.resting = allNames.filter(name => !playingNames.has(name));
    });
    
    // ëŒ€ì§„í‘œ ë‹¤ì‹œ í‘œì‹œ
    displaySchedule(currentSchedule);
    
    closeEditModal();
    showToast('ëŒ€ì§„í‘œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœï¸', 'success');
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
    const modal = document.getElementById('editScheduleModal');
    if (e.target === modal) {
        closeEditModal();
    }
});
</script>

<!-- ëŒ€ì§„í‘œ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editScheduleModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto; margin: auto;">
        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">âœï¸ ëŒ€ì§„í‘œ ìˆ˜ì •</h3>
            <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">&times;</button>
        </div>
        <div id="editModalBody" style="padding: 20px;">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>
        <div style="padding: 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="saveScheduleEdits()">ğŸ’¾ ì €ì¥</button>
        </div>
    </div>
</div>

<style>
.edit-schedule-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.edit-round h4 {
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
    color: #1e293b;
}

.edit-matches {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.edit-match {
    background: #f8fafc;
    border-radius: 12px;
    padding: 16px;
    border: 1px solid #e2e8f0;
}

.edit-match-header {
    font-weight: 600;
    color: #64748b;
    margin-bottom: 12px;
    font-size: 14px;
}

.edit-teams {
    display: flex;
    align-items: center;
    gap: 12px;
}

.edit-team {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.edit-team select {
    font-size: 14px;
    padding: 8px 12px;
}

.edit-vs {
    font-weight: 700;
    color: #94a3b8;
    padding: 0 8px;
}

@media (max-width: 600px) {
    .edit-teams {
        flex-direction: column;
    }
    
    .edit-vs {
        padding: 8px 0;
    }
}
</style>
{% endblock %}

